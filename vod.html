<!DOCTYPE html>
<html>
<head>
<title>HBC Twitch VOD backups</title>
<link rel="icon" href="twitchbreab.png">
<link rel="stylesheet" href="style.css">
</head>
<body>

<h1 style="background-color: #18181b"><a href="/"><img src="twitchbreab.svg" width=60></a>HBC Twitch VOD backups</h1>
<div id="titlewrapper">
    <h2 id="title"></h2>
    <div id="vodwrapper">
        <figure id="videoContainer">
            <video id="vod" preload="auto"></video>
            <div id="video-controls" class="controls">
                <div id="leftcontrols">
                  <button id="playpause" type="button" class="hover" hovertext="Play"><svg width="20" height="20" version="1.1" viewBox="0 0 20 20" x="0px" y="0px" role="presentation" aria-hidden="true" focusable="false" id="playicon"><g><path d="M5 17.066V2.934a.5.5 0 01.777-.416L17 10 5.777 17.482A.5.5 0 015 17.066z"></path></g></svg><svg width="20" height="20" version="1.1" viewBox="0 0 20 20" x="0px" y="0px" role="presentation" aria-hidden="true" focusable="false" id="pauseicon"><g><path d="M8 3H4v14h4V3zM16 3h-4v14h4V3z"></path></g></svg></button><button id="mute" type="button" class="hover" hovertext="Mute"><svg width="20" height="20" version="1.1" viewBox="0 0 20 20" x="0px" y="0px" role="presentation" aria-hidden="true" focusable="false" id="unmuteicon"><path d="M5 7l4.146-4.146a.5.5 0 01.854.353v13.586a.5.5 0 01-.854.353L5 13H4a2 2 0 01-2-2V9a2 2 0 012-2h1zM12 8.414L13.414 7l1.623 1.623L16.66 7l1.414 1.414-1.623 1.623 1.623 1.623-1.414 1.414-1.623-1.623-1.623 1.623L12 11.66l1.623-1.623L12 8.414z"></path></svg><svg width="20" height="20" version="1.1" viewBox="0 0 20 20" x="0px" y="0px" role="presentation" aria-hidden="true" focusable="false" id="muteicon"><g><path d="M9.146 2.853L5 7H4a2 2 0 00-2 2v2a2 2 0 002 2h1l4.146 4.146a.5.5 0 00.854-.353V3.207a.5.5 0 00-.854-.353zM12 8a2 2 0 110 4V8z"></path><path d="M12 6a4 4 0 010 8v2a6 6 0 000-12v2z"></path></g></svg></button>
                </div>
                <div id="progress-bar">
                    <div id="time">0:00</div>
                    <div id="progress-empty">
                        <div id="progress-full">
                            <div id="cicle"></div>
                        </div>
                    </div>
                </div>
                <div id="rightcontrols">
                    <button id="copytime" class="hover" hovertext="Copy Timestamp"><svg width=20 height=20><image xlink:href="https://upload.wikimedia.org/wikipedia/commons/e/e9/OOjs_UI_icon_link-ltr-invert.svg" width="20" height="20"></svg></button><button id="fs" type="button" class="hover" hovertext="Fullscreen"><svg width="20" height="20" viewBox="0 0 20 20" focusable="false" aria-hidden="true" role="presentation" id="fullicon"><path d="M7 3H2v5h2V5h3V3zm11 5V3h-5v2h3v3h2zm-5 9v-2h3v-3h2v5h-5zm-9-5H2v5h5v-2H4v-3z"></path></svg><svg width="20" height="20" viewBox="0 0 20 20" focusable="false" aria-hidden="true" role="presentation" id="unfullicon"><path d="M8 8V3H6v3H2v2h6zm4 0h6V6h-4V3h-2v5zm0 9v-5h6v2h-4v3h-2zm-4-5H2v2h4v3h2v-5z"></path></svg></button>
                </div>
            </div>
        </figure>
    </div>
</div>
<div id="chatwrapper">
    <h2>Chat</h2>
    <div id="chat"></div>
</div>
<script>
    const params = new URLSearchParams(window.location.search);
    const id = params.get("v");
    const timestamp = params.get("t") || 0;
    const hl = params.get("hl")
    const colors = ["#FF0000", "#0000FF", "#008000", "#B22222", "#FF7F50", "#9ACD32", "#FF4500", "#2E8B57", "#DAA520", "#D2691E", "#5F9EA0", "#1E90FF", "#FF69B4", "#8A2BE2", "#00FF7F"];
    let pickedColors = {};

    let chunklen = 300
    let length = 3600
    let chunks = 1
    let currentChunk = 1
    let loadingnext = false

    const highlightsheet = new CSSStyleSheet()
    function messageTimestamp(msgid, seconds) {
        window.history.pushState("object or string", "eeee", "vod.html?v=" + id + "&t=" + seconds + "&hl=" + msgid)
        highlightsheet.replaceSync("#" + msgid + " {background-color: #35353b}")
        //document.getElementById("vod").currentTime = seconds
        skipto(seconds)
    }

    var client = new XMLHttpRequest();
    client.open('GET', "metadata/" + id + ".json");
    client.onreadystatechange = function() {
        if (client.readyState == 4) {
            if (client.status == 200) {
                const metadata = JSON.parse(client.responseText);
                document.getElementById("title").innerText = metadata.title;
                document.title = metadata.title + " - HBC Twitch VOD backups"
    
                currentChunk = Math.ceil(timestamp / chunklen)
                if (currentChunk < 1) {
                    currentChunk = 1
                }
                document.getElementById("vod").src = "vods/" + id + "_" + currentChunk + ".mp4"
                document.getElementById("vod").currentTime = timestamp;

                length = metadata.length
                chunks = Math.ceil(length / chunklen)
                
                //console.log(badges);
                
                var loadchat = new XMLHttpRequest();
                loadchat.open('GET', "chat/" + id + ".html");
                loadchat.onreadystatechange = function() {
                    if (loadchat.readyState == 4) {
                        const chat = document.getElementById("chat")
                        if (loadchat.status == 200) {
                            chat.innerHTML = loadchat.responseText
                            if (document.getElementById(hl)) {
                                document.getElementById(hl).scrollIntoView({behavior: "smooth", block: "center"})
                            }
                        } else {
                            chat.innerText = "Error: " + loadchat.status
                        }
                    }
                }
                loadchat.send()
            } else {
                document.getElementById("title").innerText = "Error: " + client.status;
                document.getElementById("vod").style.display = "none";
                document.getElementById("chatwrapper").style.display = "none";
            }
        }
    }

    client.send();
    highlightsheet.replaceSync("#" + hl + " {background-color: #35353b}")
    document.adoptedStyleSheets = [highlightsheet]

    // https://stackoverflow.com/a/28839954
    function preload(ch) {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "vods/" + id + "_" + ch + ".mp4", true);
        xhr.responseType = "arraybuffer";

        xhr.onload = function(oEvent) {
            var blob = new Blob([oEvent.target.response], {type: "video/mp4"});

            if (loadingnext) {
                console.log("next chunk loaded")
                currentChunk++
                loadingnext = false
                let cur = video.currentTime
                video.src = URL.createObjectURL(blob);
                video.currentTime = cur - chunklen
                video.play()
            }
        };

        xhr.onprogress = function(oEvent) {

            if (oEvent.lengthComputable) {
                var percentComplete = oEvent.loaded/oEvent.total;
                console.log(percentComplete)
                // do something with this
            }
        }

        xhr.send();
    }

    // https://developer.mozilla.org/en-US/docs/Web/Media/Audio_and_video_delivery/cross_browser_video_player

    const videoContainer = document.getElementById("videoContainer");
    const video = document.getElementById("vod");
    const videoControls = document.getElementById("video-controls");

    const playpause = document.getElementById("playpause");
    const mute = document.getElementById("mute");/*
    const volinc = document.getElementById("volinc");
    const voldec = document.getElementById("voldec");*/
    const progress = document.getElementById("progress-bar");
    const progressfull = document.getElementById("progress-full");
    const fullscreen = document.getElementById("fs");
    const copytime = document.getElementById("copytime");

    const playicon = document.getElementById("playicon")
    const pauseicon = document.getElementById("pauseicon")
    const unmuteicon = document.getElementById("unmuteicon")
    const muteicon = document.getElementById("muteicon")
    const fullicon = document.getElementById("fullicon")
    const unfullicon = document.getElementById("unfullicon")

    pauseicon.style.display = "none"
    unmuteicon.style.display = "none"
    unfullicon.style.display = "none"

    let paused = video.paused
    let movingbar = false
    playpause.addEventListener("click", (e) => {
      if (video.paused || video.ended) {
        video.play();
        paused = false
        pauseicon.style.display = "inline"
        playicon.style.display = "none"
        playpause.setAttribute("hovertext", "Pause")
      } else {
        video.pause();
        paused = true
        pauseicon.style.display = "none"
        playicon.style.display = "inline"
        playpause.setAttribute("hovertext", "Play")
      }
    });

    mute.addEventListener("click", (e) => {
        video.muted = !video.muted;
        if (video.muted) {
            unmuteicon.style.display = "inline"
            muteicon.style.display = "none"
            mute.setAttribute("hovertext", "Unmute")
        } else {
            unmuteicon.style.display = "none"
            muteicon.style.display = "inline"
            mute.setAttribute("hovertext", "Mute")
        }
    });
/*
    function alterVolume(dir) {
      const currentVolume = Math.floor(video.volume * 10) / 10;
      if (dir === "+" && currentVolume < 1) {
        video.volume += 0.1;
      } else if (dir === "-" && currentVolume > 0) {
        video.volume -= 0.1;
      }
    }

    volinc.addEventListener("click", (e) => {
      alterVolume("+");
    });
    voldec.addEventListener("click", (e) => {
      alterVolume("-");
    });* /

    video.addEventListener("loadedmetadata", () => {
      progress.setAttribute("max", video.duration);
    });*/

    video.addEventListener("timeupdate", () => {
        progressfull.style.width = (video.currentTime + (currentChunk - 1) * chunklen) / length * 100 + "%"
        //console.log("timeupdate", (video.currentTime + (currentChunk - 1) * 3600))
        let string = ""
        const seconds = video.currentTime  + (currentChunk - 1) * chunklen
        const hours = Math.floor(seconds / 3600)
        let displaySeconds = seconds - hours * 3600
        const minutes = Math.floor(displaySeconds / 60)
        displaySeconds = displaySeconds - minutes * 60
        if (hours > 0) {
            string = string + hours + ":"
            if (minutes < 10) {
                string = string + 0
            }
        }
        string = string + minutes + ":"
        if (displaySeconds < 10) {
            string = string + 0
        }
        string = string + Math.floor(displaySeconds)

        document.getElementById("time").innerText = string

        let ch = Math.ceil(seconds / chunklen)
        if (ch > currentChunk && !loadingnext) {
            console.log("loading next chunk")
            loadingnext = true
            preload(ch)
        }
    });
/*
    document.getElementById("vodload").addEventListener("canplaythrough", (e) => {
        if (loadingnext) {
            console.log("next chunk loaded")
            currentChunk++
            loadingnext = false
            let cur = video.currentTime
            video.src = "/vods/" + id + "_" + currentChunk + ".mp4"
            video.currentTime = cur - 3600
        }
    })*/

    function skipto(time) {
        progressfull.style.width = (time / length) * 100 + "%"
        //console.log("skipto", time)
        loadingnext = false
        //document.getElementById("vodload").src = null
        let ch = Math.ceil(time / chunklen)
        if (ch != currentChunk) {
            currentChunk = ch
            video.src = "vods/" + id + "_" + currentChunk + ".mp4"
            video.currentTime = time - (currentChunk - 1) * chunklen
        } else {
            video.currentTime = time - (currentChunk - 1) * chunklen
        }
    }

    progress.addEventListener("mousedown", (e) => {
      const rect = progress.getBoundingClientRect();
      const pos = (e.pageX - rect.left) / progress.offsetWidth;
      skipto(pos * length)
      video.pause()
      movingbar = true
    });
    document.addEventListener("mousemove", (e) => {
        if (movingbar) {
          const rect = progress.getBoundingClientRect();
          const pos = (e.pageX - rect.left) / progress.offsetWidth;
          skipto(pos * length)
        }
    });
    document.addEventListener("mouseup", (e) => {
        if (movingbar) {
          const rect = progress.getBoundingClientRect();
          const pos = (e.pageX - rect.left) / progress.offsetWidth;
          skipto(pos * length)
          movingbar = false
          if (!paused) {
            video.play()
          }
        }
    });

    function setFullscreenData(state) {
      videoContainer.setAttribute("data-fullscreen", !!state);
    }

    document.addEventListener("fullscreenchange", (e) => {
      setFullscreenData(!!document.fullscreenElement);
    });

    function handleFullscreen() {
      if (document.fullscreenElement !== null) {
        // The document is in fullscreen mode
        document.exitFullscreen();
        setFullscreenData(false);
        videoControls.style.width = null
        unfullicon.style.display = "none"
        fullicon.style.display = "inline"
        fs.setAttribute("hovertext", "Fullscreen")
      } else {
        // The document is not in fullscreen mode
        videoContainer.requestFullscreen();
        setFullscreenData(true);
        videoControls.style.width = "100vw"
        unfullicon.style.display = "inline"
        fullicon.style.display = "none"
        fs.setAttribute("hovertext", "Exit Fullscreen")
      }
    }

    fullscreen.addEventListener("click", (e) => {
      handleFullscreen();
    });

    function setTextBack() {
        copytime.setAttribute("hovertext", "Copy Timestamp")
    }
    copytime.addEventListener("click", (e) => {
        navigator.clipboard.writeText("https://ccerisegd.github.io/hbcvods/vod.html?v=" + id + "&t=" + Math.floor(video.currentTime + (currentChunk - 1) * chunklen))
        copytime.setAttribute("hovertext", "Copied!")
        setTimeout(setTextBack, 2000)
    });
</script>

</body>
</html>
